@{
	ViewData["Title"] = "Start Chatting";
}


<div class="alert alert-success" id="userActivityInfo" style="display: none; text-align: center;">
</div>
<div class="row">
	<div class="col-md-3 col-log-3">
		<div class="index-card">
			<div>
				<h3>Welcome</h3>
				<br />
				<input type="text" placeholder="User Name" class="form-control" id="userName" />
				<br />
				<button id="joinBtn" type="button" class="btn btn-light btn-outline-dark">Start Chatting</button>
			</div>
		</div>
		<br />
		<br />
		<div class="index-card">
			<div>
				<h3>Create Room</h3>
				<br />
				<input type="text" placeholder="Room Name" class="form-control disabled" id="roomName" />
				<br />
				<button type="button" class="btn btn-light btn-outline-dark" disabled>Add Room</button>
			</div>
		</div>
	</div>
	<div class="col-md-6 col-lg-6" style="background-color:lavender;">
		<br />
		<div style="height: 60%; background-color: white;" class="overflow-auto form-control">
			<div class="list-group messages">
				<a href="#" class="list-group-item list-group-item-action message">
					<div class="d-flex w-100 justify-content-between">
						<h5 class="mb-1"></h5>
						<h5 class="mb-1"></h5>
					</div>
					<p class="mb-1"></p>
				</a>
			</div>
		</div>
		<br />
		<div>
			<label for="msgArea" class="form-label">Write your message...</label>
			<textarea class="form-control disabled" id="msgArea" rows="2"></textarea>
			<br />
			<div style="display:flex; justify-content: right;">
				<button type="button" class="btn btn-light btn-outline-dark" id="sendMsgBtn" disabled>Send</button>
			</div>
		</div>
	</div>
	<div class="col-md-3 col-lg-3">
		<h3>Online Users</h3>
		<div class="list-group" id="userList" role="tablist">
			<a href="#" class="list-group-item list-group-item-action users" data-toggle="list" role="tab">All</a>
			<div id="_users"></div>
		</div>
		<br />
		<h3>Active Rooms</h3>
		<div class="list-group" id="roomList" role="tablist">
			<a href="#" class="list-group-item list-group-item-action" data-toggle="list" role="tab">Item 1</a>
			<a href="#" class="list-group-item list-group-item-action" data-toggle="list" role="tab">Item 2</a>
			<a href="#" class="list-group-item list-group-item-action" data-toggle="list" role="tab">Item 3</a>
		</div>
	</div>
</div>

@section Scripts {
	<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
	<script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
	<script>
		$(document).ready(() => {

			const hubConnection = new signalR.HubConnectionBuilder().withUrl("https://localhost:44327/chathub").build();

			hubConnection.start();

			$(".disabled").attr("disabled", "disabled");

			$("#joinBtn").click(() => {
				const userName = $("#userName").val();
				hubConnection.invoke("GetUserName", userName).catch(error => console.log(error));
				$(".disabled").removeAttr("disabled");
				$(".btn").removeAttr("disabled");
				$("#joinBtn").prop("disabled", true);
				$("#userName").prop("disabled", true);
			});

			hubConnection.on("userJoined", userName => {
				$("#userActivityInfo").html(userName + " has just joined!")
				$("#userActivityInfo").fadeIn(5000, () => {
					setTimeout(() => {
						$("#userActivityInfo").fadeOut(2000);
					}, 2000);
				})
			});

			hubConnection.on("getClients", clients => {
				$("#_users").html("");
				$.each(clients, (index, item) => {
					const user = $(".users").first().clone();
					user.html(item.userName);
					$("#_users").append(user);
				});
			});

			$('body').on('click', '.users', function (e) {
				$(".users").each((index, item) => {
					$(item).removeClass("active");
				});
				$(this).addClass("active");
			});

			$('#roomList a').on('click', function (e) {
				e.preventDefault();
				$(this).toggleClass('active');
			});

			$("#sendMsgBtn").click(() => {
				const clientName = $(".users.active").first().html();
				const message = $("#msgArea").val();
				hubConnection.invoke("SendMessageAsync", message, clientName).catch(error => console.log(error));
				const msg = $(".message").clone();
				msg.removeClass("message");
				msg.find("p").html(message);
				msg.find("div h5")[1].innerHTML = "You";
				$(".messages").append(msg);
			});

			hubConnection.on("receiveMessage", (message, username) => {
				const msg = $(".message").clone();
				msg.removeClass("message");
				msg.find("p").html(message);
				msg.find("div h5")[0].innerHTML = username;
				$(".messages").append(msg);
			});
		});
	</script>
}